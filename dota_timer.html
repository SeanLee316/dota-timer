<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Dota 2 Таймер v7 (LockScreen)</title>
    <style>
        /* --- ОБЩИЕ СТИЛИ --- */
        :root {
            --bg-color: #1c1c1e;
            --panel-bg-color: #2a2a2a;
            --text-color: #e0e0e0;
            --accent-color: #00aeff;
            --accent-hover-color: #007acc;
            --warning-color: #ffc107;
            --event-now-color: #dc3545;
            --positive-color: #5cb85c;
            --positive-hover-color: #4cae4c;
        }
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; /* Убираем прокрутку по умолчанию, будем управлять ей */
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px; /* Базовый размер шрифта */
        }
        .app-wrapper { /* Новая обертка для всего приложения */
            display: flex;
            flex-direction: column; /* Для обычного режима */
            align-items: center;
            width: 100%;
            height: 100%;
            padding: 10px;
            box-sizing: border-box;
            overflow-y: auto; /* Разрешаем прокрутку для обычного режима */
        }
        .main-container {
            display: flex;
            flex-direction: row;
            width: 100%;
            max-width: 1300px;
            gap: 15px;
            flex-grow: 1; /* Чтобы занимал доступное место в .app-wrapper */
            min-height: 0; /* Для корректной работы flex-grow и overflow в дочерних */
        }
        .left-panel, .right-panel {
            display: flex;
            flex-direction: column;
            min-width: 0; /* Для сжатия */
            overflow: hidden; /* Скрываем избыток контента по умолчанию */
        }
        .left-panel { flex: 2.5; align-items: center; }
        .right-panel {
            flex: 1.5;
            background-color: var(--panel-bg-color);
            padding: 10px 12px;
            border-radius: 8px;
            overflow-y: auto; /* Прокрутка для полного лога */
        }
        #timerDisplay {
            font-size: 3.2em; margin-bottom: 8px; color: var(--accent-color);
            font-weight: bold; text-shadow: 0 0 5px rgba(0,174,255,0.5);
            text-align: center;
        }
        .controls-column {
            display: flex; flex-direction: column; align-items: center;
            gap: 8px; margin-bottom: 12px; width: 100%;
        }
        .control-group { /* Новая обертка для групп кнопок */
            display: flex; align-items: center; gap: 8px;
            background-color: var(--panel-bg-color);
            padding: 8px; border-radius: 5px;
            flex-wrap: wrap; justify-content: center;
            width: calc(100% - 16px); box-sizing: border-box;
        }
        .control-group input[type="number"] {
            width: 45px; padding: 7px; font-size: 0.95em; text-align: center;
            border: 1px solid #444; background-color: #333; color: var(--text-color);
            border-radius: 3px; -moz-appearance: textfield;
        }
        .control-group input[type="number"]::-webkit-outer-spin-button,
        .control-group input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none; margin: 0;
        }
        .control-group span { font-size: 1.1em; color: var(--accent-color); }
        .control-group button {
            font-size: 0.95em; padding: 7px 12px; cursor: pointer;
            border: none; border-radius: 5px; color: #ffffff;
            transition: background-color 0.2s ease-in-out;
        }
        .main-controls button, #lockScreenToggle { background-color: var(--accent-color); }
        .main-controls button:hover, #lockScreenToggle:hover { background-color: var(--accent-hover-color); }
        .time-sync-controls button { background-color: var(--positive-color); }
        .time-sync-controls button:hover { background-color: var(--positive-hover-color); }
        .notification-controls button { background-color: var(--warning-color); color: #1e1e1e; }
        .notification-controls button:hover { background-color: #e0a800; }

        .section-title {
            text-align: center; color: var(--accent-color);
            font-size: 1.4em; margin-bottom: 8px;
        }
        #upcomingEvents { width:100%; max-width: 600px; overflow-y: auto; flex-shrink: 1; }
        #upcomingEvents ul, #pastEventsLog ul, #dynamicRecentEventsList ul {
            list-style: none; padding: 0; margin:0;
        }
        #upcomingEvents li, #pastEventsLog li, #dynamicRecentEventsList li {
            background-color: #333333; padding: 8px 10px; margin-bottom: 6px;
            border-radius: 4px; font-size: 1em;
            border-left: 3px solid var(--accent-color);
        }
        #pastEventsLog li { border-left-color: var(--positive-color); font-size: 0.9em; }
        #upcomingEvents li .event-details {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 4px;
        }
        .event-name { font-weight: bold; }
        .event-time, .log-time { color: #b0b0b0; font-size:0.95em; }
        .progress-bar-container {
            height: 10px; /* Заметнее прогресс-бар */
            background-color: #555; border-radius: 5px;
            overflow: hidden; margin-top: 5px;
        }
        .progress-bar {
            height: 100%; background-color: var(--accent-color); width: 0%;
            transition: width 0.5s linear;
        }
        .alert-warning { border-left-color: var(--warning-color) !important; }
        .alert-event-now {
            border-left-color: var(--event-now-color) !important;
            animation: pulse 0.8s infinite alternate;
        }
        @keyframes pulse {
            0% { background-color: rgba(220, 53, 69, 0.4); }
            100% { background-color: rgba(220, 53, 69, 0.15); }
        }
        .right-panel::-webkit-scrollbar { width: 6px; }
        .right-panel::-webkit-scrollbar-track { background: var(--panel-bg-color); border-radius: 6px; }
        .right-panel::-webkit-scrollbar-thumb { background: #555; border-radius: 6px; }
        .right-panel::-webkit-scrollbar-thumb:hover { background: #777; }
        .status-messages {
            font-size: 0.8em; color: #aaa; margin-top: 4px;
            text-align: center; min-height: 1em; width: 100%;
        }
        #dynamicRecentEventsContainer {
            width: calc(100% - 16px); margin-top: 10px; padding: 8px;
            background-color: #272729; border-radius: 5px; box-sizing: border-box;
            overflow-y: auto; flex-shrink: 0; /* Не сжимать, если есть контент */
        }
        #dynamicRecentEventsContainer .section-title { font-size: 1.1em; margin-bottom: 6px; }
        #dynamicRecentEventsList li {
            background-color: #38383a; padding: 6px 8px; font-size: 0.9em;
            display: flex; justify-content: space-between; align-items: center;
            border-left: 3px solid #ff9800;
        }
        #dynamicRecentEventsList .event-name { font-weight: normal; }
        #dynamicRecentEventsList .event-meta { font-size: 0.85em; color: #c0c0c0; }
        #dynamicRecentEventsList .event-timeout { font-size: 0.8em; color: #999; margin-left: 8px;}

        /* --- АДАПТАЦИЯ (ОБЫЧНЫЙ РЕЖИМ) --- */
        @media (max-width: 768px) and (orientation: portrait) {
            .app-wrapper { padding: 5px; }
            .main-container { flex-direction: column; gap: 10px; }
            .left-panel, .right-panel { flex-basis: auto; width: 100%; }
            .right-panel { max-height: 30vh; }
            #dynamicRecentEventsContainer { order: 3; /* Поместить после upcoming events */}
        }
        @media (max-height: 550px) and (orientation: landscape) and (max-width: 900px) { /* Обычный горизонтальный для телефонов */
            .app-wrapper { padding: 5px; }
            body { font-size: 12.5px; }
            .main-container { gap: 8px; }
            .left-panel { flex: 3; }
            .right-panel { flex: 1.8; font-size: 0.8em; padding: 8px; }
            #timerDisplay { font-size: 2.8em; }
            .control-group button { font-size: 0.85em; padding: 5px 8px; margin: 3px; }
            .control-group input[type="number"] { width: 38px; padding: 5px; font-size: 0.85em;}
            .section-title { font-size: 1.2em; }
            #upcomingEvents li { padding: 6px 8px; font-size: 0.95em; }
            #dynamicRecentEventsContainer { display: block; order: 3; }
            .right-panel { max-height: calc(100vh - 20px); }
        }
        @media (min-width: 769px) and (max-width: 1024px) and (orientation: landscape) {
            body { font-size: 13.5px; }
            .left-panel { flex: 2.2; }
            .right-panel { flex: 1.8; }
        }

        /* --- LOCKSCREEN РЕЖИМ --- */
        body.horizontal-lockscreen-mode {
            font-size: 16px; /* Базовый для LockScreen, будем использовать vh/vw для масштабирования */
        }
        body.horizontal-lockscreen-mode .app-wrapper {
            padding: 0; /* Без отступов */
            overflow: hidden; /* Строго без прокрутки */
        }
        body.horizontal-lockscreen-mode .main-container {
            flex-direction: column; /* Основные блоки вертикально */
            height: 100%; /* Занять всю высоту viewport */
            width: 100%;
            padding: 2vh 2vw; /* Отступы в % от viewport */
            gap: 1.5vh;
            justify-content: space-between; /* Распределить пространство */
            box-sizing: border-box;
            background-color: #000; /* Черный фон для LockScreen */
        }
        body.horizontal-lockscreen-mode .controls-column,
        body.horizontal-lockscreen-mode .right-panel, /* Скрываем полный лог */
        body.horizontal-lockscreen-mode #wakeLockStatus,
        body.horizontal-lockscreen-mode #notificationStatus,
        body.horizontal-lockscreen-mode #upcomingEvents > .section-title, /* Скрываем заголовок "Ближайшие события" */
        body.horizontal-lockscreen-mode #lockScreenToggle { /* Скрываем кнопку активации режима */
            display: none !important;
        }
        body.horizontal-lockscreen-mode .left-panel {
            flex: 1; width: 100%;
            justify-content: flex-start; /* Таймер вверху, остальное ниже */
            align-items: center; /* Центрируем контент левой панели */
            overflow: hidden;
            gap: 2vh;
        }
        body.horizontal-lockscreen-mode #timerDisplay {
            font-size: min(12vh, 10vw); /* Адаптивный размер таймера */
            line-height: 1;
            margin-bottom: 1vh;
            flex-shrink: 0; /* Не сжимать */
        }
        body.horizontal-lockscreen-mode #upcomingEvents {
            width: 100%;
            max-width: none; /* Убираем ограничение */
            flex-grow: 1; /* Занимает доступное место */
            overflow-y: hidden; /* Стараемся уместить без скролла */
             display: flex; flex-direction: column; justify-content: space-around; /* Распределить 3-5 событий */
        }
        body.horizontal-lockscreen-mode #upcomingEvents ul {
            display: flex; flex-direction: column;
            height: 100%;
            justify-content: space-around; /* Равномерно распределить элементы */
        }
        body.horizontal-lockscreen-mode #upcomingEvents li {
            padding: 1.5vh 2vw;
            font-size: min(3vh, 2.8vw); /* Адаптивный шрифт для событий */
            border-left-width: 5px; /* Заметнее */
            flex-grow: 1; margin-bottom: 1vh; /* Равномерное распределение */
            display: flex; flex-direction: column; justify-content: center;
        }
        body.horizontal-lockscreen-mode #upcomingEvents li:last-child { margin-bottom: 0; }

        body.horizontal-lockscreen-mode #upcomingEvents li .event-details {
             flex-direction: column; align-items: flex-start; gap: 0.5vh;
        }
        body.horizontal-lockscreen-mode #upcomingEvents li .event-name { font-size: 1em; }
        body.horizontal-lockscreen-mode #upcomingEvents li .event-time { font-size: 0.8em; }
        body.horizontal-lockscreen-mode #upcomingEvents li .progress-bar-container {
            height: 1.8vh; /* Большой прогресс-бар */
            border-radius: 0.9vh;
            margin-top: 1vh;
        }
        body.horizontal-lockscreen-mode #dynamicRecentEventsContainer {
            display: block !important;
            width: 100%;
            padding: 1vh 1.5vw;
            font-size: min(2.2vh, 2vw);
            background-color: #111; /* Темнее для недавних */
            border-top: 1px solid #333;
            flex-shrink: 0; /* Не сжимать */
            max-height: 25vh; /* Ограничение высоты для недавних */
            overflow-y: auto;
        }
        body.horizontal-lockscreen-mode #dynamicRecentEventsContainer .section-title {
            display: block; font-size: 0.9em; margin-bottom: 0.5vh; color: #ccc;
        }
        body.horizontal-lockscreen-mode #dynamicRecentEventsList li {
            padding: 0.8vh 1vw; font-size: 1em;
        }
        body.horizontal-lockscreen-mode #dynamicRecentEventsList .event-timeout { display: inline; }
        /* Кнопка выхода (если понадобится, хотя ESC/жест назад должны работать) */
        /* #exitLockScreenButton { position: fixed; top: 10px; right: 10px; z-index: 10000; ... } */
    </style>
</head>
<body>
    <div class="app-wrapper">
        <div class="main-container">
            <div class="left-panel">
                <div id="timerDisplay">00:00</div>
                <div class="controls-column">
                    <div class="control-group time-sync-controls">
                        <input type="number" id="syncMinutes" placeholder="MM" min="0">
                        <span>:</span>
                        <input type="number" id="syncSeconds" placeholder="SS" min="0" max="59">
                        <button id="syncButton">Синхронизировать</button>
                    </div>
                    <div class="control-group main-controls">
                        <button id="startButton">Start Timer</button>
                        <button id="resetButton">Reset Timer</button>
                        <button id="lockScreenToggle">📱 Горизонт. Режим</button> </div>
                    <div class="control-group notification-controls">
                        <button id="toggleNotificationsButton">Включить Уведомления</button>
                    </div>
                </div>
                 <div id="wakeLockStatus" class="status-messages"></div>
                 <div id="notificationStatus" class="status-messages"></div>

                <div id="upcomingEvents" style="width:100%; max-width:600px;">
                    <h2 class="section-title">Ближайшие события</h2>
                    <ul id="eventsList"></ul>
                </div>
                <div id="dynamicRecentEventsContainer">
                    <h2 class="section-title">Недавние Активности</h2>
                    <ul id="dynamicRecentEventsList"></ul>
                </div>
            </div>
            <div class="right-panel">
                <h2 class="section-title">Полный Лог</h2>
                <ul id="pastEventsLogList"></ul>
            </div>
        </div>
    </div>
    <audio id="warningSoundPlayer" src="warning_alert.mp3" preload="auto"></audio>
    <audio id="eventNowSoundPlayer" src="event_now_alert.mp3" preload="auto"></audio>

    <script>
        // ... (весь JavaScript из предыдущей версии v6) ...
        // ДОБАВЛЯЕМ НОВЫЙ КОД НИЖЕ:

        const lockScreenToggleButton = document.getElementById('lockScreenToggle');
        // const exitLockScreenButton = document.getElementById('exitLockScreenButton'); // Если решите добавить кнопку выхода

        // --- LockScreen Mode Logic ---
        async function enterLockScreenMode() {
            document.body.classList.add('horizontal-lockscreen-mode');
            document.querySelector('.app-wrapper').scrollTop = 0; // Предотвратить скролл внутри обертки
            lockScreenToggleButton.textContent = 'Выйти из Горизонт.';
            // exitLockScreenButton.style.display = 'block'; // Показать кнопку выхода

            if (document.documentElement.requestFullscreen) {
                try { await document.documentElement.requestFullscreen(); } catch (err) { console.warn("Fullscreen request failed:", err.message); }
            }
            if (screen.orientation && screen.orientation.lock) {
                try { await screen.orientation.lock('landscape'); } catch (err) { console.warn("Orientation lock failed:", err.message); }
            }
            if (isTimerRunning && !wakeLockSentinel) { // Если таймер уже идет, запросить wake lock
                await requestWakeLock();
            }
            updateUpcomingEventsDisplay(true); // Показать меньше событий
            updateDynamicRecentEventsDisplay(); // Обновить, т.к. размеры могли измениться
        }

        async function exitLockScreenMode() {
            document.body.classList.remove('horizontal-lockscreen-mode');
            lockScreenToggleButton.textContent = '📱 Горизонт. Режим';
            // exitLockScreenButton.style.display = 'none';

            if (document.fullscreenElement && document.exitFullscreen) {
                try { await document.exitFullscreen(); } catch (err) { console.warn("Exit fullscreen failed:", err.message); }
            }
            if (screen.orientation && screen.orientation.unlock) {
                try { screen.orientation.unlock(); } catch (err) { console.warn("Orientation unlock failed:", err.message); }
            }
            // Wake lock управляется основным Start/Pause/Reset, здесь не трогаем, если только не было спец. логики для lockscreen
            updateUpcomingEventsDisplay(false); // Показать обычное кол-во событий
        }

        lockScreenToggleButton.addEventListener('click', () => {
            if (document.body.classList.contains('horizontal-lockscreen-mode')) {
                exitLockScreenMode();
            } else {
                enterLockScreenMode();
            }
        });

        // Обработка нажатия ESC для выхода из fullscreen (браузер сам выходит из fullscreen, мы синхронизируем состояние UI)
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement && document.body.classList.contains('horizontal-lockscreen-mode')) {
                // Если вышли из fullscreen (например, по ESC), а режим LockScreen еще активен в UI
                exitLockScreenMode(); // Синхронизируем UI
            }
        });
        
        // --- Модификация updateUpcomingEventsDisplay ---
        // Замените существующую функцию updateUpcomingEventsDisplay на эту:
        function updateUpcomingEventsDisplay(isLockScreen = false) { // Добавлен параметр
            const upcoming = [];
            const displayLimitFutureSeconds = gameTimeInSeconds + 15 * 60;
            // Определение количества отображаемых элементов
            const maxEventsToShow = isLockScreen ? 4 : 7; // 4 для LockScreen, 7 для обычного

            eventStates.forEach(event => {
                // ... (логика сбора upcoming событий остается такой же, как в v6) ...
                 if (event.isOneTime && !event.alertedEvent) {
                    if (event.spawnTime <= displayLimitFutureSeconds && event.spawnTime > gameTimeInSeconds) {
                        upcoming.push({ name: event.name, time: event.spawnTime, eventObj: event });
                    }
                } else if (event.spawnTimes) {
                     event.spawnTimes.forEach((spawnTime, index) => {
                        if (!event.alertedEvent[index] && spawnTime <= displayLimitFutureSeconds && spawnTime > gameTimeInSeconds) {
                             upcoming.push({ name: `${event.name}`, time: spawnTime, eventObj: event, spawnIndex: index });
                        }
                    });
                } else if (!event.isOneTime && !event.spawnTimes) { 
                    if (event.nextSpawnTime <= displayLimitFutureSeconds && gameTimeInSeconds < event.nextSpawnTime) {
                        upcoming.push({ name: event.name, time: event.nextSpawnTime, eventObj: event });
                    }
                }
            });

            upcoming.sort((a, b) => a.time - b.time);
            eventsList.innerHTML = ''; // Очищаем старый список
            
            upcoming.slice(0, maxEventsToShow).forEach(e => { // Используем maxEventsToShow
                const listItem = document.createElement('li');
                const timeToSpawn = e.time - gameTimeInSeconds;
                let progressBarHtml = '';
                if (timeToSpawn <= PROGRESS_WINDOW_SECONDS && timeToSpawn > 0) {
                    const elapsedInWindow = PROGRESS_WINDOW_SECONDS - timeToSpawn;
                    const progressPercent = Math.min(100, Math.max(0, (elapsedInWindow / PROGRESS_WINDOW_SECONDS) * 100));
                    progressBarHtml = `<div class="progress-bar-container"><div class="progress-bar" style="width: ${progressPercent}%;"></div></div>`;
                }
                listItem.innerHTML = `<div class="event-details"><span class="event-name">${e.name}</span><span class="event-time">через ${formatTime(timeToSpawn)} (в ${formatTime(e.time)})</span></div>${progressBarHtml}`;
                let isWarningActive = false;
                if (e.eventObj.isOneTime) isWarningActive = e.eventObj.alertedWarning;
                else if (e.eventObj.spawnTimes) isWarningActive = e.eventObj.alertedWarning[e.spawnIndex];
                else isWarningActive = e.eventObj.alertedWarning;
                if (timeToSpawn <= 0 && timeToSpawn > -ALERT_OFFSET_SECONDS) listItem.classList.add('alert-event-now');
                else if (isWarningActive && timeToSpawn > 0 && timeToSpawn <= ALERT_OFFSET_SECONDS) listItem.classList.add('alert-warning');
                eventsList.appendChild(listItem);
            });
            // ... (остальная логика отображения 'нет событий' остается) ...
            if (upcoming.length === 0 && isTimerRunning) eventsList.innerHTML = '<li>Нет ожидаемых событий.</li>';
            else if (!isTimerRunning && upcoming.length === 0) eventsList.innerHTML = '<li>Запустите или синхронизируйте таймер.</li>';
            else if (!isTimerRunning && gameTimeInSeconds === 0) eventsList.innerHTML = '<li>Таймер не запущен.</li>';
        }


        // --- JavaScript из предыдущей версии (v6) без изменений, кроме тех, что указаны выше ---
        // Вставьте сюда ВЕСЬ JavaScript из предыдущего ответа (v6), 
        // ЗА ИСКЛЮЧЕНИЕМ функции updateUpcomingEventsDisplay, которую мы заменили выше.
        // Убедитесь, что объявление lockScreenToggleButton находится вместе с другими const в начале скрипта.
        // const timerDisplay = document.getElementById('timerDisplay');
        // const startButton = document.getElementById('startButton');
        // ... и так далее
        // Включая все функции: getBaseEventDefinitions, initializeEventStates, rebuildPastEventsLog, formatTime,
        // updateTimerDisplay, playSound, updatePastEventsLogDisplay, checkAndTriggerAlerts,
        // mainLoop, attemptInitialSoundUnlock, обработчики для startButton, resetButton, syncButton,
        // updateNotificationButtonText, toggleNotificationsButton listener, showBrowserNotification,
        // requestWakeLock, releaseWakeLock, visibilitychange listener.

        // И в самом конце, перед </script>:
        // updateAllDisplays(); // Вызываем для начальной отрисовки
        // updateNotificationButtonText(); // Обновляем текст кнопки уведомлений
        // (Это уже должно быть в коде v6)
        // Инициализация (этот блок уже должен быть в конце скрипта v6)
        // initializeEventStates(0);
        // updateAllDisplays(); // Эта функция теперь должна включать updateDynamicRecentEventsDisplay()
        // updateNotificationButtonText(); // Это тоже должно быть
        
        // Убедитесь, что `updateAllDisplays` включает `updateDynamicRecentEventsDisplay`
        // function updateAllDisplays() {
        //     updateTimerDisplay();
        //     updateUpcomingEventsDisplay(document.body.classList.contains('horizontal-lockscreen-mode')); // Передаем состояние LockScreen
        //     updatePastEventsLogDisplay();
        //     updateDynamicRecentEventsDisplay();
        // }
        // (переопределите updateAllDisplays если нужно, чтобы она знала о lockscreen mode для upcoming events)
        // Проще всего будет в `enterLockScreenMode` и `exitLockScreenMode` вызывать `updateUpcomingEventsDisplay` с нужным флагом.

        // Переопределяем updateAllDisplays, чтобы она корректно вызывала updateUpcomingEventsDisplay
        function updateAllDisplays() {
            updateTimerDisplay();
            updateUpcomingEventsDisplay(document.body.classList.contains('horizontal-lockscreen-mode'));
            updatePastEventsLogDisplay();
            updateDynamicRecentEventsDisplay();
        }
        // Инициализация
        initializeEventStates(0);
        updateAllDisplays();
        updateNotificationButtonText();


    </script>
</body>
</html>
